name: Run setup through Emacs and see if it gives errors

on: [push, pull_request]

# Why have a pipeline?
# - To see that quick pushes don't break anything
# - (Older) packages might be deleted from Melpa (happened with Pretty-Lambdada), and then I can fix it before experiencing it on a new machine (which might happen much later when I'm too dependent on that package)
# - See that the changes will work on any machine and don't depend on local circumstances
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: purcell/setup-emacs@v3.0
        with:
          version: 27.2
      - name: Tangle, byte-compile (replaces old init.el) and run new setup
        run: |
          RUN_DATA=$(HOME=$GITHUB_WORKSPACE/.. emacs --no-window-system --eval "(setq truncate-lines nil)" --script init.el)
          echo "$RUN_DATA"
          WARNINGS=$(echo "$RUN_DATA" 2>&1 | grep Warning)
          echo "# Tangle and byte-compile report\n## Warnings\n$WARNINGS" >> $GITHUB_STEP_SUMMARY
