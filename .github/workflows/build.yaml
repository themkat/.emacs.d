name: Run setup through Emacs and see if it gives errors

on: [push, pull_request]

# Why have a pipeline?
# - To see that quick pushes don't break anything
# - (Older) packages might be deleted from Melpa (happened with Pretty-Lambdada), and then I can fix it before experiencing it on a new machine (which might happen much later when I'm too dependent on that package)
# - See that the changes will work on any machine and don't depend on local circumstances
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: purcell/setup-emacs@v3.0
        with:
          version: 27.2
      - name: Tangle, byte-compile (replaces old init.el) and run new setup
        run: |
          RUN_DATA=$(HOME=$GITHUB_WORKSPACE/.. emacs --no-window-system --batch --script init.el 2>&1)
          echo "$RUN_DATA"
          WARNINGS=$(echo "$RUN_DATA" | sed '{/Warning/N;s/\n//;}' |  grep Warning | sed -E 's/^(.*\.el)/- \*\*\1\*\*/')
          LOAD_ERRORS=$(echo "$RUN_DATA" | grep "Cannot load" | sed 's/^/- /')
          echo -e "# Tangle and byte-compile report\n## Errors\n$LOAD_ERRORS\n## Warnings\n$WARNINGS" >> $GITHUB_STEP_SUMMARY
          [ -z $LOAD_ERRORS ] || exit 1
